name: Build iOS Archive â€“Â debug cert

on:
  workflow_dispatch:

jobs:
  archive:
    runs-on: macos-latest
    env:
      APPLE_TEAM_ID: Q9YK4JBX2Q
      APP_IDENTIFIER: kalimba.world

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node & pods
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - run: |
          npm ci
          npx cap sync ios
      - run: |
          cd ios/App && pod install

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” P12 debug info
        id: p12dbg
        run: |
          echo "::group::Print first/last bytes of secret"
          echo "$P12_BASE64" | head -c 32 ; echo " â€¦ "
          echo "$P12_BASE64" | tail -c 32
          echo "::endgroup::"

          echo "$P12_BASE64" | base64 --decode > dist.p12
          echo "::group::File details"
          ls -l dist.p12
          shasum -a 1 dist.p12
          echo "::endgroup::"

          echo "::group::OpenSSL inspect"
          openssl pkcs12 -in dist.p12 -nokeys -info -passin pass: || true
          echo "::endgroup::"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Try import
        run: |
          set -e
          echo "Attempt import with empty passphraseâ€¦"
          if security import dist.p12 -k "$HOME/Library/Keychains/login.keychain-db" -P "" -A -T /usr/bin/codesign ; then
            echo "âœ… imported with empty password"
          elif [ -n "$P12_PASSWORD" ]; then
            echo "Retrying with P12_PASSWORD secretâ€¦"
            security import dist.p12 -k "$HOME/Library/Keychains/login.keychain-db" -P "$P12_PASSWORD" -A -T /usr/bin/codesign
            echo "âœ… imported with P12_PASSWORD"
          else
            echo "âŒ  import failed with both empty and blank password" >&2
            exit 1
          fi

      # stop after proving import so we donâ€™t waste time
      - name: Done
        run: echo "Stop here once import works; then reâ€‘enable the build steps."
